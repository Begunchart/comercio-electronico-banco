server {
    listen ${PORT};
    
    # Use Docker's internal DNS resolver to enable lazy resolution of upstreams
    resolver 127.0.0.11 valid=30s ipv6=off;

    location / {
        return 404;
    }

    location /auth/ {
        # Using a variable forces Nginx to resolve the hostname at request time, not startup
        set $auth_upstream ${AUTH_SERVICE_URL};
        proxy_pass http://$auth_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /core/ {
        set $core_upstream ${CORE_SERVICE_URL};
        proxy_pass http://$core_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

